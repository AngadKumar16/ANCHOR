# Core Data Schema (ANCHOR)

This document is the canonical schema reference for the ANCHOR Core Data model (`AnchorModel.xcdatamodeld`).

## Naming & codegen
- **Recommended entity Codegen**: `Manual/None` if you use hand-maintained NSManagedObject subclasses. If you prefer autogenerated classes, set Codegen = `Class Definition` and do not add manual NSManagedObject subclass files that conflict.
- **Model filename**: `AnchorModel` (or `ANCHOR` if you prefer). Ensure `PersistenceController` uses the same name.

---

## Entities

### JournalEntryEntity
| Attribute      | Type       | Optional | Notes |
| -------------- | ---------- | -------- | ----- |
| id             | UUID       | No       | Primary identifier |
| date           | Date       | No       | Creation date |
| title          | String     | Yes      | Optional short title |
| bodyEncrypted  | Binary Data| Yes      | Encrypted AES-GCM ciphertext (Allows External Storage recommended) |
| sentiment      | Int16      | No       | -1, 0, 1 mapped to negative/neutral/positive |
| tags           | String     | Yes      | CSV of tags (non-sensitive) |

**Indexing**: Add an index on `date` for fast queries and sorting.

**Notes**:
- Store `bodyEncrypted` as Binary Data and NEVER store plaintext body in the model.
- Use `JournalEntryEntity` extensions for convenience decryption methods: `decryptedBody()`.

---

### UserProfileEntity
| Attribute  | Type | Optional | Notes |
| ---------- | ---- | -------- | ----- |
| id         | UUID | No       | Primary identifier |
| displayName| String | Yes    | Optional display name |
| anonymousId| String | Yes    | Random id for anonymous peer features |
| createdAt  | Date | No       | Creation timestamp |

**Notes**:
- Display name is non-sensitive. If you decide to store PII (email, phone), encrypt those fields.

---

### RiskAssessmentEntity
| Attribute | Type   | Optional | Notes |
| --------- | ------ | -------- | ----- |
| id        | UUID   | No       | Primary identifier |
| date      | Date   | No       | timestamp |
| score     | Double | No       | 0.0 - 100.0 |
| reason    | String | Yes      | Short explanation (non-sensitive) |

**Notes**:
- Consider storing `reason` as non-sensitive text; if it contains sensitive info, store as encrypted `Binary Data`.

---

## Migrations & versioning
- Use lightweight migration for additive changes. Prefer adding optional attributes with defaults.
- For structural changes (renaming attributes/entities), use a Mapping Model or manual migration path and test on a copy of production DB.
- Always include a migration test in your CI that runs the migration path from previous persistent stores to the current model version.

---

## Indexing & performance
- Index `date` attributes for `JournalEntryEntity` and `RiskAssessmentEntity`.
- Use `Allows External Storage` for `bodyEncrypted` to keep the SQLite file lean.
- Batch fetch for lists and use reasonable fetch limits for analytics.

---

## Sample fetch requests

**Fetch recent 20 journal entries**
```swift
let req: NSFetchRequest<JournalEntryEntity> = JournalEntryEntity.fetchRequest()
req.sortDescriptors = [NSSortDescriptor(key: "date", ascending: false)]
req.fetchLimit = 20
let results = try context.fetch(req)
